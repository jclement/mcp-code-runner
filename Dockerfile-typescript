FROM oven/bun:1-alpine

# Add labels for runner discovery
LABEL sandbox.runner=true
LABEL sandbox.language=typescript

# Bun alpine images come with 'bun' user (UID 1000)
# Create directories and set ownership
RUN mkdir -p /data /tmp && \
    chown -R bun:bun /data /tmp

# Install runtime dependencies for database libraries
RUN apk add --no-cache \
    postgresql-libs \
    sqlite-libs

# Install database and CSV packages
RUN bun add -g postgres pg csv-parser papaparse

# Create runner script inline
RUN cat > /usr/local/bin/runner.sh <<'EOF'
#!/bin/sh
set -e

# Read code from stdin to fixed path
cat > /tmp/script.ts

# Run the code as user 1000:1000
cd /data
exec bun run /tmp/script.ts
EOF

RUN chmod +x /usr/local/bin/runner.sh

# Set working directory
WORKDIR /data

# Run as non-root user (permissions are set by sandbox manager before container starts)
USER 1000:1000

# Entrypoint
ENTRYPOINT ["/usr/local/bin/runner.sh"]
