FROM python:3.12-alpine

# Add labels for runner discovery
LABEL sandbox.runner=true
LABEL sandbox.language=python

# Create non-root user for security
RUN adduser -D -u 1000 sandbox

# Create directories
RUN mkdir -p /data /tmp && \
    chown sandbox:sandbox /data /tmp

# Install runtime dependencies (keep these)
RUN apk add --no-cache \
    libstdc++ \
    freetype \
    libpng \
    postgresql-libs \
    sqlite-libs

# Install build dependencies temporarily
RUN apk add --no-cache --virtual .build-deps \
    gcc \
    musl-dev \
    g++ \
    freetype-dev \
    libpng-dev \
    postgresql-dev

# Install common Python packages that might be useful
RUN pip install --no-cache-dir \
    requests \
    numpy \
    pandas \
    matplotlib \
    psycopg2

# Clean up build dependencies to reduce image size (keep runtime libs)
RUN apk del .build-deps

# Create runner script inline
RUN cat > /usr/local/bin/runner.sh <<'EOF'
#!/bin/sh
set -e

# Read code from stdin to fixed path
cat > /tmp/script.py

# Run the code as user 1000:1000
cd /data
exec python /tmp/script.py
EOF

RUN chmod +x /usr/local/bin/runner.sh

# Set working directory
WORKDIR /data

# Run as non-root user (permissions are set by sandbox manager before container starts)
USER 1000:1000

# Entrypoint
ENTRYPOINT ["/usr/local/bin/runner.sh"]
